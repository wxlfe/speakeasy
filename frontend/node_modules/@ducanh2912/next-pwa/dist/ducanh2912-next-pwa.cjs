"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("clean-webpack-plugin"),t=require("crypto"),n=require("fast-glob"),i=require("fs"),o=require("path"),r=require("url"),s=require("workbox-webpack-plugin"),a=require("module"),c=require("terser-webpack-plugin"),l=require("webpack"),p={$schema:"https://json.schemastore.org/swcrc",module:{type:"es6",lazy:!0,noInterop:!0},jsc:{parser:{syntax:"typescript",tsx:!0,dynamicImport:!0,decorators:!1},transform:{react:{runtime:"automatic"}},target:"es2022",loose:!1},minify:!1};const u=e=>{Object.defineProperty(e,"alreadyCalled",{get:()=>!1,set(){}})},d=e=>void 0!==e&&"string"==typeof e.swSrc,m=(e,t)=>{for(const n of e){const e=t(n);if(e)return e}},f=a.createRequire("undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("ducanh2912-next-pwa.cjs",document.baseURI).href),_=({id:t,baseDir:n,customWorkerDir:r,destDir:s,plugins:a,tsconfig:u,minify:d})=>{let m="";const _=o.join(n,r),h=o.join(n,"src",r);if(i.existsSync(_)?m=_:i.existsSync(h)&&(m=h),!m)return;const g=`worker-${t}.js`,A=["ts","js"].map((e=>o.join(m,`index.${e}`))).filter((e=>i.existsSync(e)));if(0===A.length)return;if(A.length>1)return void console.warn(`> [PWA] WARNING: More than one custom worker found (${A.join(",")}), a custom worker will not be built.`);const x=A[0];return console.log(`> [PWA] Custom worker found: ${x}`),console.log(`> [PWA] Building custom worker: ${o.join(s,g)}...`),u&&u.compilerOptions&&u.compilerOptions.paths&&((e,t,n)=>{e.jsc.baseUrl=t,e.jsc.paths=n})(p,o.join(n,u.compilerOptions.baseUrl??"."),u.compilerOptions.paths),l({mode:d?"production":"development",target:"webworker",entry:{main:x},resolve:{extensions:[".ts",".js"],fallback:{module:!1,dgram:!1,dns:!1,path:!1,fs:!1,os:!1,crypto:!1,stream:!1,http2:!1,net:!1,tls:!1,zlib:!1,child_process:!1}},resolveLoader:{alias:{"swc-loader":f.resolve("swc-loader")}},module:{rules:[{test:/\.(t|j)s$/i,use:[{loader:"swc-loader",options:p}]}]},output:{path:s,filename:g},plugins:[new e.CleanWebpackPlugin({cleanOnceBeforeBuildPatterns:[o.join(s,"worker-*.js"),o.join(s,"worker-*.js.map")]})].concat(a??[]),optimization:d?{minimize:!0,minimizer:[new c]}:void 0}).run(((e,t)=>{(e||t?.hasErrors())&&(console.error("> [PWA] Failed to build custom worker."),console.error(t?.toString({colors:!0})),process.exit(-1))})),g},h=r.fileURLToPath(new URL(".","undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("ducanh2912-next-pwa.cjs",document.baseURI).href)),g=a.createRequire("undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("ducanh2912-next-pwa.cjs",document.baseURI).href),A=({id:t,fallbacks:n,destDir:i,minify:r})=>{const s=(({fallbacks:e,id:t})=>{let n=e.data;n&&n.endsWith(".json")&&(n=o.posix.join("/_next/data",t,n));const i={__PWA_FALLBACK_DOCUMENT__:e.document||!1,__PWA_FALLBACK_IMAGE__:e.image||!1,__PWA_FALLBACK_AUDIO__:e.audio||!1,__PWA_FALLBACK_VIDEO__:e.video||!1,__PWA_FALLBACK_FONT__:e.font||!1,__PWA_FALLBACK_DATA__:n||!1};if(0!==Object.values(i).filter((e=>!!e)).length)return console.log("> [PWA] This app will fallback to these precached routes when fetching from cache or network fails:"),i.__PWA_FALLBACK_DOCUMENT__&&console.log(`> [PWA]   Documents (pages): ${i.__PWA_FALLBACK_DOCUMENT__}`),i.__PWA_FALLBACK_IMAGE__&&console.log(`> [PWA]   Images: ${i.__PWA_FALLBACK_IMAGE__}`),i.__PWA_FALLBACK_AUDIO__&&console.log(`> [PWA]   Audio: ${i.__PWA_FALLBACK_AUDIO__}`),i.__PWA_FALLBACK_VIDEO__&&console.log(`> [PWA]   Videos: ${i.__PWA_FALLBACK_VIDEO__}`),i.__PWA_FALLBACK_FONT__&&console.log(`> [PWA]   Fonts: ${i.__PWA_FALLBACK_FONT__}`),i.__PWA_FALLBACK_DATA__&&console.log(`> [PWA]   Data (/_next/data/**/*.json): ${i.__PWA_FALLBACK_DATA__}`),i})({fallbacks:n,id:t});if(!s)return;const a=`fallback-${t}.js`,u=o.join(h,"fallback.js");return l({mode:r?"production":"development",target:"webworker",entry:{main:u},resolve:{extensions:[".js"],fallback:{module:!1,dgram:!1,dns:!1,path:!1,fs:!1,os:!1,crypto:!1,stream:!1,http2:!1,net:!1,tls:!1,zlib:!1,child_process:!1}},resolveLoader:{alias:{"swc-loader":g.resolve("swc-loader")}},module:{rules:[{test:/\.(t|j)s$/i,use:[{loader:"swc-loader",options:p}]}]},output:{path:i,filename:a},plugins:[new e.CleanWebpackPlugin({cleanOnceBeforeBuildPatterns:[o.join(i,"fallback-*.js"),o.join(i,"fallback-*.js.map")]}),new l.EnvironmentPlugin(s)],optimization:r?{minimize:!0,minimizer:[new c]}:void 0}).run(((e,t)=>{(e||t?.hasErrors())&&(console.error("> [PWA] Failed to build fallback worker."),console.error(t?.toString({colors:!0})),process.exit(-1))})),{name:a,precaches:Object.values(s).filter((e=>!!e))}},x=[{urlPattern:/^https:\/\/fonts\.(?:gstatic)\.com\/.*/i,handler:"CacheFirst",options:{cacheName:"google-fonts-webfonts",expiration:{maxEntries:4,maxAgeSeconds:31536e3}}},{urlPattern:/^https:\/\/fonts\.(?:googleapis)\.com\/.*/i,handler:"StaleWhileRevalidate",options:{cacheName:"google-fonts-stylesheets",expiration:{maxEntries:4,maxAgeSeconds:604800}}},{urlPattern:/\.(?:eot|otf|ttc|ttf|woff|woff2|font.css)$/i,handler:"StaleWhileRevalidate",options:{cacheName:"static-font-assets",expiration:{maxEntries:4,maxAgeSeconds:604800}}},{urlPattern:/\.(?:jpg|jpeg|gif|png|svg|ico|webp)$/i,handler:"StaleWhileRevalidate",options:{cacheName:"static-image-assets",expiration:{maxEntries:64,maxAgeSeconds:2592e3}}},{urlPattern:/\/_next\/image\?url=.+$/i,handler:"StaleWhileRevalidate",options:{cacheName:"next-image",expiration:{maxEntries:64,maxAgeSeconds:86400}}},{urlPattern:/\.(?:mp3|wav|ogg)$/i,handler:"CacheFirst",options:{rangeRequests:!0,cacheName:"static-audio-assets",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:/\.(?:mp4)$/i,handler:"CacheFirst",options:{rangeRequests:!0,cacheName:"static-video-assets",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:/\.(?:js)$/i,handler:"StaleWhileRevalidate",options:{cacheName:"static-js-assets",expiration:{maxEntries:48,maxAgeSeconds:86400}}},{urlPattern:/\.(?:css|less)$/i,handler:"StaleWhileRevalidate",options:{cacheName:"static-style-assets",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:/\/_next\/data\/.+\/.+\.json$/i,handler:"StaleWhileRevalidate",options:{cacheName:"next-data",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:/\.(?:json|xml|csv)$/i,handler:"NetworkFirst",options:{cacheName:"static-data-assets",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:({sameOrigin:e,url:t})=>{if(!e)return!1;const n=t.pathname;return!n.startsWith("/api/auth/")&&!!n.startsWith("/api/")},handler:"NetworkFirst",method:"GET",options:{cacheName:"apis",expiration:{maxEntries:16,maxAgeSeconds:86400},networkTimeoutSeconds:10}},{urlPattern:({url:e,sameOrigin:t})=>{if(!t)return!1;return!e.pathname.startsWith("/api/")},handler:"NetworkFirst",options:{cacheName:"others",expiration:{maxEntries:32,maxAgeSeconds:86400}}},{urlPattern:({sameOrigin:e})=>!e,handler:"NetworkFirst",options:{cacheName:"cross-origin",expiration:{maxEntries:32,maxAgeSeconds:3600},networkTimeoutSeconds:10}}],w=r.fileURLToPath(new URL(".","undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("ducanh2912-next-pwa.cjs",document.baseURI).href));exports.default=(r={})=>(a={})=>({...a,...{webpack(c,l){const p=!!a.experimental?.appDir,f=l.webpack,{buildId:h,dev:g,config:{distDir:j=".next",pageExtensions:P=["tsx","ts","jsx","js","mdx"]}}=l;let b=l.config.basePath;b||(b="/");const W=((e,t)=>{try{const n=m([t??"tsconfig.json","jsconfig.json"],(t=>{const n=o.join(e,t);return i.existsSync(n)?n:void 0}));if(!n)return;return JSON.parse(i.readFileSync(n,"utf-8"))}catch{return}})(l.dir,a?.typescript?.tsconfigPath),{disable:y=!1,register:k=!0,dest:S=j,sw:L="sw.js",cacheStartUrl:v=!0,dynamicStartUrl:E=!0,dynamicStartUrlRedirect:$,publicExcludes:O=["!noprecache/**/*"],buildExcludes:C=[],fallbacks:R={},cacheOnFrontEndNav:F=!1,reloadOnOnline:N=!0,scope:D=b,customWorkerDir:U="worker",workboxOptions:B={}}=r,{swSrc:T,additionalManifestEntries:I,modifyURLPrefix:q={},manifestTransforms:K=[],exclude:M,...z}=B;"function"==typeof a.webpack&&(c=a.webpack(c,l)),Object.keys(z).forEach((e=>void 0===z[e]&&delete z[e]));let G=[],V=x;if(c.plugins||(c.plugins=[]),y)return l.isServer&&console.log("> [PWA] PWA support is disabled."),c;console.log(`> [PWA] Compiling for ${l.isServer?"server":"client (static)"}...`),(e=>!d(e))(B)&&(B.runtimeCaching&&(console.log("> [PWA] Custom runtimeCaching array found, using it instead of the default one."),V=B.runtimeCaching),B.importScripts&&(G=B.importScripts));const H=o.posix.join(D,"/"),J=o.posix.join(b,L.startsWith("/")?L:`/${L}`);c.plugins.push(new f.DefinePlugin({__PWA_SW__:`'${J}'`,__PWA_SCOPE__:`'${H}'`,__PWA_ENABLE_REGISTER__:`${Boolean(k)}`,__PWA_START_URL__:E?`'${b}'`:void 0,__PWA_CACHE_ON_FRONT_END_NAV__:`${Boolean(F)}`,__PWA_RELOAD_ON_ONLINE__:`${Boolean(N)}`}));const Y=o.join(w,"sw-entry.js"),Q=c.entry;if(c.entry=()=>Q().then((e=>(e["main.js"]&&!e["main.js"].includes(Y)&&(Array.isArray(e["main.js"])?e["main.js"].unshift(Y):"string"==typeof e["main.js"]&&(e["main.js"]=[Y,e["main.js"]])),e["main-app"]&&!e["main-app"].includes(Y)&&(Array.isArray(e["main-app"])?e["main-app"].unshift(Y):"string"==typeof e["main-app"]&&(e["main-app"]=[Y,e["main-app"]])),e))),!l.isServer){const r=o.join(l.dir,S),a=_({id:h,baseDir:l.dir,customWorkerDir:U,destDir:r,plugins:c.plugins.filter((e=>e instanceof f.DefinePlugin)),tsconfig:W,minify:!g});a&&G.unshift(a),k?console.log(`> [PWA] Service worker will be automatically registered with: ${o.resolve(Y)}`):(console.log("> [PWA] Service worker won't be automatically registered as per the config, please call the following code in a componentDidMount callback or useEffect hook:"),console.log("> [PWA]   window.workbox.register()"),W?.compilerOptions?.types?.includes("@ducanh2912/next-pwa/workbox")||console.log("> [PWA] You may also want to add @ducanh2912/next-pwa/workbox to compilerOptions.types in your tsconfig.json/jsconfig.json.")),console.log(`> [PWA] Service worker: ${o.join(r,L)}`),console.log(`> [PWA]   URL: ${J}`),console.log(`> [PWA]   Scope: ${H}`),c.plugins.push(new e.CleanWebpackPlugin({cleanOnceBeforeBuildPatterns:[o.join(r,"workbox-*.js"),o.join(r,"workbox-*.js.map"),o.join(r,L),o.join(r,`${L}.map`)]}));let x=I??[];x||(x=n.sync(["**/*","!workbox-*.js","!workbox-*.js.map","!worker-*.js","!worker-*.js.map","!fallback-*.js","!fallback-*.js.map",`!${L.replace(/^\/+/,"")}`,`!${L.replace(/^\/+/,"")}.map`,...O],{cwd:"public"}).map((e=>{return{url:o.posix.join(b,`/${e}`),revision:(n=`public/${e}`,t.createHash("md5").update(i.readFileSync(n)).digest("hex"))};var n}))),v&&(E?"string"==typeof $&&$.length>0&&x.push({url:$,revision:h}):x.push({url:b,revision:h}));let w=!1;if(R){R.document||(R.document=((e,t,n)=>{const r=m(["pages","src/pages"],(t=>(t=o.join(e,t),i.existsSync(t)?t:void 0))),s=n?m(["app","src/app"],(t=>(t=o.join(e,t),i.existsSync(t)?t:void 0))):void 0;if(r||s)for(const e of t){if(s){const t=o.join(s,`~offline/page.${e}`);if(i.existsSync(t))return"/~offline";const n=o.join(s,`_offline/page.${e}`);if(i.existsSync(n))return console.warn('> [PWA] Next.js App Router now ignores folders prefixed by underscore (_). Please replace "/_offline" with "/~offline". "/_offline" in "app/" will no longer automatically enable the fallback worker in the next major version.'),"/_offline"}if(r){const t=o.join(r,`_offline.${e}`);if(t&&i.existsSync(t))return"/_offline"}}})(l.dir,P,p));const e=A({id:h,fallbacks:R,baseDir:l.dir,destDir:r,minify:!g,pageExtensions:P,isAppDirEnabled:p});e&&(w=!0,G.unshift(e.name),e.precaches.forEach((e=>{e&&"boolean"!=typeof e&&!x.find((t=>"string"!=typeof t&&t.url.startsWith(e)))&&x.push({url:e,revision:h})})))}const j={swDest:o.join(r,L),additionalManifestEntries:g?[]:x,exclude:[...C,({asset:e})=>!(!e.name.startsWith("server/")&&!e.name.match(/^((app-|^)build-manifest\.json|react-loadable-manifest\.json)$/))||!(!g||e.name.startsWith("static/runtime/"))],modifyURLPrefix:{...q,"/_next/../public/":"/"},manifestTransforms:[...K,async(e,t)=>({manifest:e.map((e=>{if(e.url=e.url.replace("/_next//static/image","/_next/static/image"),e.url=e.url.replace("/_next//static/media","/_next/static/media"),null===e.revision){let n=e.url;c.output&&c.output.publicPath&&"string"==typeof c.output.publicPath&&n.startsWith(c.output.publicPath)&&(n=e.url.substring(c.output.publicPath.length));const i=t.assetsInfo.get(n);e.revision=i&&i.contenthash||h}return e.url=e.url.replace(/\[/g,"%5B").replace(/\]/g,"%5D"),e})),warnings:[]})]};if(d(B)){const e=o.join(l.dir,B.swSrc);console.log(`> [PWA] Using InjectManifest with ${e}`);const t=new s.InjectManifest({...j,...z,swSrc:e});g&&u(t),c.plugins.push(t)}else{const{skipWaiting:e=!0,clientsClaim:t=!0,cleanupOutdatedCaches:n=!0,ignoreURLParametersMatching:i=[]}=B;let o=!1;g&&(console.log("> [PWA] Building in development mode, caching and precaching are disabled for the most part. This means that offline support is disabled, but you can continue developing other functions in service worker."),i.push(/ts/),V=[{urlPattern:/.*/i,handler:"NetworkOnly",options:{cacheName:"dev"}}],o=!0),E&&V.unshift({urlPattern:b,handler:"NetworkFirst",options:{cacheName:"start-url",plugins:[{cacheWillUpdate:async({response:e})=>e&&"opaqueredirect"===e.type?new Response(e.body,{status:200,statusText:"OK",headers:e.headers}):e}]}}),w&&V.forEach((e=>{e.options&&(e.options.precacheFallback||Array.isArray(e.options.plugins)&&e.options.plugins.find((e=>"handlerDidError"in e))||(e.options.plugins||(e.options.plugins=[]),e.options.plugins.push({handlerDidError:async({request:e})=>"undefined"!=typeof self?self.fallback(e):Response.error()})))}));const r=new s.GenerateSW({...j,skipWaiting:e,clientsClaim:t,cleanupOutdatedCaches:n,ignoreURLParametersMatching:i,importScripts:G,...z,runtimeCaching:V});o&&u(r),c.plugins.push(r)}}return c}}}),exports.runtimeCaching=x;